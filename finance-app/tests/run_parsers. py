# -*- coding: utf-8 -*-
"""
Test parsers on real data files with actual imports
"""
import sys
import os

# Set UTF-8 encoding for stdout
if sys.platform == 'win32':
    sys.stdout.reconfigure(encoding='utf-8')

# Add src to path
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))

from src import parsers

# Test files from raw-test-data
test_data_dir = os.path.join(os.path.dirname(__file__), 'raw-test-data')

if os.path.exists(test_data_dir):
    files = os.listdir(test_data_dir)
    print(f"Testing {len(files)} files with actual parsers:\n")
    print("="*80)
    
    total_parsed = 0
    
    for filename in files:
        print(f"\nFile: {filename}")
        print("-"*80)
        filepath = os.path.join(test_data_dir, filename)
        
        try:
            with open(filepath, 'rb') as f:
                transactions = parsers.detect_and_parse(f, filename)
                
            print(f"Result: {len(transactions)} transactions parsed")
            
            if transactions:
                # Show first 5 transactions
                for i, tx in enumerate(transactions[:5]):
                    desc = tx['description'][:50]
                    print(f"  {i+1}. {tx['date']} | {tx['amount']:>10.2f} | {desc}")
                
                if len(transactions) > 5:
                    print(f"  ... and {len(transactions) - 5} more")
                
                # Summary stats
                expenses = [t for t in transactions if t['amount'] < 0]
                income = [t for t in transactions if t['amount'] > 0]
                
                total_expense = sum(t['amount'] for t in expenses)
                total_income = sum(t['amount'] for t in income)
                
                print(f"\nSummary:")
                print(f"  Expenses: {len(expenses)} transactions, total: {total_expense:,.2f}")
                print(f"  Income:   {len(income)} transactions, total: {total_income:,.2f}")
                
                total_parsed += len(transactions)
            else:
                print("  [WARNING] No transactions found!")
                
        except Exception as e:
            print(f"  [ERROR] {e}")
            import traceback
            traceback.print_exc()
        
        print()
    
    print("="*80)
    print(f"TOTAL: {total_parsed} transactions parsed from all files")
else:
    print(f"[ERROR] Directory not found: {test_data_dir}")
